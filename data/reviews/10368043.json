{
	"description": "runtime: do not generate code during runtime in windows NewCallback\n\nUpdate Issue 5494",
	"cc": [
		"golang-dev@googlegroups.com",
		"minux.ma@gmail.com",
		"rsc@golang.org",
		"iant@golang.org"
	],
	"reviewers": [],
	"messages": [
		{
			"sender": "alex.brainman@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "Hello golang-dev@googlegroups.com,\n\nI'd like you to review this change to\nhttps://go.googlecode.com/hg/",
			"disapproval": false,
			"date": "2013-06-18 02:44:18.738730",
			"approval": false
		},
		{
			"sender": "minux.ma@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "https://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/callback_windows.c\nFile src/pkg/runtime/callback_windows.c (right):\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/callback_windows.c#newcode31\nsrc/pkg/runtime/callback_windows.c:31: WinCallbackContext* c;\nfor consistency, WinCallbackContext *c;\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows.s\nFile src/pkg/runtime/sys_windows.s (right):\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows.s#newcode12\nsrc/pkg/runtime/sys_windows.s:12: TEXT runtime\u00b7callbackasm(SB),7,$0\ni guess this big but mechanical source file is better generated by cmd/dist\nas zcallback_windows.c??\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s\nFile src/pkg/runtime/sys_windows_386.s (right):\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s#newcode173\nsrc/pkg/runtime/sys_windows_386.s:173: ADDL\t$4, SP\nwhy not just combine these two as POP AX? i think it makes the intention very clear.\n(of course, you may have to adjust offset of SP below)\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s#newcode198\nsrc/pkg/runtime/sys_windows_386.s:198: MULL\tBX\nuse SHLL?\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s#newcode200\nsrc/pkg/runtime/sys_windows_386.s:200: MOVL\t(AX), BX\nor better, delete code from SUBL $1, AX to ADDL runtime..., AX\nand just use something like this:\nMOVL runtime\u00b7cbctxts+-4(SB)(AX*4), BX\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_amd64.s\nFile src/pkg/runtime/sys_windows_amd64.s (right):\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_amd64.s#newcode228\nsrc/pkg/runtime/sys_windows_amd64.s:228: MOVQ\t(AX), AX\nsame",
			"disapproval": false,
			"date": "2013-06-18 07:58:24.273960",
			"approval": false
		},
		{
			"sender": "alex.brainman@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "Hello golang-dev@googlegroups.com, minux.ma@gmail.com (cc: golang-dev@googlegroups.com),\n\nPlease take another look.",
			"disapproval": false,
			"date": "2013-06-19 07:10:13.598910",
			"approval": false
		},
		{
			"sender": "alex.brainman@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "Thank you for review.\n\nAlex\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/callback_windows.c\nFile src/pkg/runtime/callback_windows.c (right):\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/callback_windows.c#newcode31\nsrc/pkg/runtime/callback_windows.c:31: WinCallbackContext* c;\nOn 2013/06/18 07:58:24, minux wrote:\n> for consistency, WinCallbackContext *c;\n\nDone.\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows.s\nFile src/pkg/runtime/sys_windows.s (right):\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows.s#newcode12\nsrc/pkg/runtime/sys_windows.s:12: TEXT runtime\u00b7callbackasm(SB),7,$0\nOn 2013/06/18 07:58:24, minux wrote:\n> i guess this big but mechanical source file is better generated by cmd/dist\n> as zcallback_windows.c??\n\nDone.\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s\nFile src/pkg/runtime/sys_windows_386.s (right):\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s#newcode173\nsrc/pkg/runtime/sys_windows_386.s:173: ADDL\t$4, SP\nBecause it does not compile. It fails with:\n\nruntime.callbackasm1: unbalanced PUSH/POP\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s#newcode198\nsrc/pkg/runtime/sys_windows_386.s:198: MULL\tBX\nOn 2013/06/18 07:58:24, minux wrote:\n> use SHLL?\n\nDone.\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s#newcode200\nsrc/pkg/runtime/sys_windows_386.s:200: MOVL\t(AX), BX\nYou meant \"MOVL runtime\u00b7cbctxts+-4(SB)(AX*4), AX\" instead, aren't you? But even that does not work. This command looks like this\n\nmov    0x709fdc(,%eax,4),%eax\n\nin gdb, while\n\n(gdb) p/x 'runtime.cbctxts'\n$2 = 0x70e444\n\nI think our asm does not work. Or we are using it wrong.\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_amd64.s\nFile src/pkg/runtime/sys_windows_amd64.s (right):\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_amd64.s#newcode228\nsrc/pkg/runtime/sys_windows_amd64.s:228: MOVQ\t(AX), AX\nUsed SHLQ here.",
			"disapproval": false,
			"date": "2013-06-19 07:11:25.169960",
			"approval": false
		},
		{
			"sender": "minux.ma@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"rsc@golang.org",
				"iant@golang.org",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "looks pretty good to me.\nplease let rsc or iant take a look before submit.\n\nthe \"MOVL -4(BX)(AX*4), AX\" is minor, feel free to ignore it.\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s\nFile src/pkg/runtime/sys_windows_386.s (right):\n\nhttps://codereview.appspot.com/10368043/diff/5001/src/pkg/runtime/sys_windows_386.s#newcode200\nsrc/pkg/runtime/sys_windows_386.s:200: MOVL\t(AX), BX\nOn 2013/06/19 07:11:25, brainman wrote:\n> You meant \"MOVL runtime\u00b7cbctxts+-4(SB)(AX*4), AX\" instead, aren't you? But even\n> that does not work. This command looks like this\n> \n> mov    0x709fdc(,%eax,4),%eax\n> \n> in gdb, while\n> \n> (gdb) p/x 'runtime.cbctxts'\n> $2 = 0x70e444\n> \n> I think our asm does not work. Or we are using it wrong.\nah, i see. the cbctxts is a pointer to an array.\nso actually, it should be something like:\nMOVL runtime\u00b7cbctxts(SB), BX\nMOVL -4(BX)(AX*4), AX\n\nhttps://codereview.appspot.com/10368043/diff/11001/src/cmd/dist/buildruntime.c\nFile src/cmd/dist/buildruntime.c (right):\n\nhttps://codereview.appspot.com/10368043/diff/11001/src/cmd/dist/buildruntime.c#newcode294\nsrc/cmd/dist/buildruntime.c:294: if(hasprefix(goos, \"windows\")) {\ns/hasprefix/streq/\n\nhttps://codereview.appspot.com/10368043/diff/11001/src/cmd/dist/buildruntime.c#newcode298\nsrc/cmd/dist/buildruntime.c:298: \"// license that can be found in the LICENSE file.\\n\"\nit seems auto generated file doesn't need copyright notices.\n\nhttps://codereview.appspot.com/10368043/diff/11001/src/cmd/dist/buildruntime.c#newcode308\nsrc/cmd/dist/buildruntime.c:308: for(i=0; i<2001; i++) {\n2001?\n\nanyway, i think we'd better make 2000 a const, and comment\nthat it should keep in sync with the other 2000 in runtime\nsource.\n\nor better, also generate a .h to contain that constant,\nso that only the cmd/dist contains the constant.",
			"disapproval": false,
			"date": "2013-06-19 11:03:58.354520",
			"approval": false
		},
		{
			"sender": "alex.brainman@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"rsc@golang.org",
				"iant@golang.org",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "On 2013/06/19 11:03:58, minux wrote:\n> ...\n> ah, i see. the cbctxts is a pointer to an array.\n> so actually, it should be something like:\n> MOVL runtime\u00b7cbctxts(SB), BX\n> MOVL -4(BX)(AX*4), AX\n\nCool. I have changed the code.\n\nAlex\n\nhttps://codereview.appspot.com/10368043/diff/11001/src/cmd/dist/buildruntime.c\nFile src/cmd/dist/buildruntime.c (right):\n\nhttps://codereview.appspot.com/10368043/diff/11001/src/cmd/dist/buildruntime.c#newcode294\nsrc/cmd/dist/buildruntime.c:294: if(hasprefix(goos, \"windows\")) {\nOn 2013/06/19 11:03:58, minux wrote:\n> s/hasprefix/streq/\n\nDone.\n\nhttps://codereview.appspot.com/10368043/diff/11001/src/cmd/dist/buildruntime.c#newcode298\nsrc/cmd/dist/buildruntime.c:298: \"// license that can be found in the LICENSE file.\\n\"\nOn 2013/06/19 11:03:58, minux wrote:\n> it seems auto generated file doesn't need copyright notices.\n\nRemoved copyright.\n\nhttps://codereview.appspot.com/10368043/diff/11001/src/cmd/dist/buildruntime.c#newcode308\nsrc/cmd/dist/buildruntime.c:308: for(i=0; i<2001; i++) {\nOn 2013/06/19 11:03:58, minux wrote:\n> 2001?\n\nI am not good at math. And I know that. I am always worried that I miscounted something. So I always try and protected myself, when I can. :-)\n\n> \n> or better, also generate a .h to contain that constant,\n> so that only the cmd/dist contains the constant.\n\nDone. Added it to zasm_$GOOS_$GOARCH.h. And included that file in callback_windows.go.",
			"disapproval": false,
			"date": "2013-06-20 02:34:11.031240",
			"approval": false
		},
		{
			"sender": "alex.brainman@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"rsc@golang.org",
				"iant@golang.org",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "Hello golang-dev@googlegroups.com, minux.ma@gmail.com, rsc@golang.org, iant@golang.org (cc: golang-dev@googlegroups.com),\n\nPlease take another look.",
			"disapproval": false,
			"date": "2013-06-20 02:34:12.314130",
			"approval": false
		},
		{
			"sender": "alex.brainman@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"rsc@golang.org",
				"iant@golang.org",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "On 2013/06/20 02:34:11, brainman wrote:\n> \n> ... And included that file in\n> callback_windows.go.\n\nI meant to say callback_windows.c.\n\nAlex",
			"disapproval": false,
			"date": "2013-06-20 02:35:20.617610",
			"approval": false
		},
		{
			"sender": "minux.ma@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"rsc@golang.org",
				"iant@golang.org",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "Very nice. LGTM. Thank you.\nPlease let rsc or iant take a look before submitting.",
			"disapproval": false,
			"date": "2013-06-20 03:51:53.938830",
			"approval": true
		},
		{
			"sender": "alex.brainman@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"rsc@golang.org",
				"iant@golang.org",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "On 2013/06/20 03:51:53, minux wrote:\n> Please let rsc or iant take a look before submitting.\n\nWill wait. Thank you.\n\nAlex",
			"disapproval": false,
			"date": "2013-06-20 03:52:33.911250",
			"approval": false
		},
		{
			"sender": "rsc@golang.org",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"rsc@golang.org",
				"iant@golang.org",
				"golang-dev@googlegroups.com",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "LGTM\n\nBeautiful.",
			"disapproval": false,
			"date": "2013-06-21 18:17:42.821320",
			"approval": true
		},
		{
			"sender": "alex.brainman@gmail.com",
			"recipients": [
				"alex.brainman@gmail.com",
				"golang-dev@googlegroups.com",
				"minux.ma@gmail.com",
				"rsc@golang.org",
				"iant@golang.org",
				"reply@codereview-hr.appspotmail.com"
			],
			"text": "*** Submitted as https://code.google.com/p/go/source/detail?r=af0c031528c3 ***\n\nruntime: do not generate code during runtime in windows NewCallback\n\nUpdate Issue 5494\n\nR=golang-dev, minux.ma, rsc, iant\nCC=golang-dev\nhttps://codereview.appspot.com/10368043",
			"disapproval": false,
			"date": "2013-06-24 07:17:54.777610",
			"approval": false
		}
	],
	"owner_email": "alex.brainman@gmail.com",
	"private": false,
	"base_url": "",
	"owner": "brainman",
	"subject": "code review 10368043: runtime: do not generate code during runtime in windows...",
	"created": "2013-06-18 02:34:23.165670",
	"patchsets": [
		1,
		2001,
		5001,
		11001,
		26001,
		38001
	],
	"modified": "2013-06-24 07:17:57.991520",
	"closed": true,
	"issue": 10368043
}